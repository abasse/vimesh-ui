<head>
    <title>Welcome</title>

    <script src="https://unpkg.com/@vimesh/ui"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="https://unpkg.com/universal-router/universal-router.min.js"></script>

    <script>
        $vui.config.importMap = {
            "*": '../components/${path}${component}.html',
            "page": '../components/spa-pages/${component}.html'
        }
        let data = {
            currentPage: 'page-welcome',
            $route: {},
            routes: [
                { path: '/welcome', action: 'page-welcome' },
                { path: '/blog/:id', action: 'page-blog' },
                { path: '(.*)', action: 'page-welcome' }
            ]
        }
    </script>
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body x-cloak x-import="header,footer" x-data="data">
    <vui-header></vui-header>
    <vui-router-view></vui-router-view>
    <vui-footer></vui-footer>
    <template x-component="router-view" x-html="$api && $api.pageContent">
        <script>
            return {
                router: null,
                get pageContent() { return `<${this.currentPage} x-import="${this.currentPage.replace('-', ':')}"></${this.currentPage}>` },
                onUrlChange() {
                    let match = window.location.href.match(/#(.*)$/)
                    let fragment = match ? match[1] : ''
                    this.router.resolve({ pathname: fragment }).then(result => {
                        this.currentPage = result
                    })
                },
                onMounted() {
                    this.router = new UniversalRouter(this.routes, {
                        context: { self: this },
                        resolveRoute(context, params) {
                            context.self.$route = { params, path: context.pathname }
                            if (typeof context.route.action === 'function') {
                                return context.route.action(context, params)
                            }
                            return context.route.action
                        }
                    })
                    this.onUrlChange()
                    window.addEventListener('popstate', e => this.onUrlChange())
                }
            }
        </script>
    </template>
</body>